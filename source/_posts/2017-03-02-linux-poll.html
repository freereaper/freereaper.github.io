---
title: "linux poll分析"
date: 2017-03-02
layout: post
categories: 
- Linux
tags: 
- Kernel 
- Driver
published: true
comments: 
---
<p>
在上层应用中使用系统调用，最终都会调用到内核中提供的接口，对于 <code>poll</code> ，与之相对应的即为 <code>sys_poll</code> 函数。
</p>

<div id="orgee31658" class="outline-2">
<h2 id="orgee31658">sys_poll</h2>
<div class="outline-text-2" id="text-orgee31658">
<p>
sys_poll函数的实现在内核中的 <a href="http://lxr.free-electrons.com/source/fs/select.c#L971">fs/select.c</a> 文件中:
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #f99157;">SYSCALL_DEFINE3</span><span style="color: #cccccc;">(</span>poll, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds,
                <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    ...

    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#22312;&#36825;&#37324;&#35843;&#29992;do_sys_poll </span><span style="color: #999999; font-style: italic;">*/</span>
    ret = <span style="color: #f99157;">do_sys_poll</span><span style="color: #66cccc;">(</span>ufds, nfds, to<span style="color: #66cccc;">)</span>;

    ...
<span style="color: #cccccc;">}</span>
</pre>
</div>

<p>
<!-- more -->
</p>


<p>
可以看看 <code>SYSCALL_DEFINE3</code> 是如何展开得到 <code>sys_poll</code> 函数的定义的
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #cc99cc;">#define</span> <span style="color: #f99157;">SYSCALL_DEFINE3</span><span style="color: #cccccc;">(</span><span style="color: #ffcc66;">name</span>, ...<span style="color: #cccccc;">)</span> <span style="color: #f99157;">SYSCALL_DEFINEx</span><span style="color: #cccccc;">(</span><span style="color: #6699cc;">3</span>, _##name, __VA_ARGS__<span style="color: #cccccc;">)</span>

<span style="color: #cc99cc;">#define</span> <span style="color: #f99157;">__SYSCALL_DEFINEx</span><span style="color: #cccccc;">(</span><span style="color: #ffcc66;">x</span>, <span style="color: #ffcc66;">name</span>, ...<span style="color: #cccccc;">)</span>                             \
    asmlinkage <span style="color: #6699cc;">long</span> <span style="color: #f99157;">sys</span>##<span style="color: #f99157;">name</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span>x,__SC_DECL,__VA_ARGS__<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>       \
        <span style="color: #f99157;">__attribute__</span><span style="color: #cccccc;">(</span><span style="color: #66cccc;">(</span><span style="color: #f99157;">alias</span><span style="color: #ffcc66;">(</span><span style="color: #f99157;">__stringify</span><span style="color: #99cc99;">(</span>SyS##name<span style="color: #99cc99;">)</span><span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>;             \
    <span style="color: #99cc99;">static</span> <span style="color: #99cc99;">inline</span> <span style="color: #6699cc;">long</span> <span style="color: #f99157;">SYSC</span>##<span style="color: #f99157;">name</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span>x,__SC_DECL,__VA_ARGS__<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>;  \
    asmlinkage <span style="color: #6699cc;">long</span> <span style="color: #f99157;">SyS</span>##<span style="color: #f99157;">name</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span>x,__SC_LONG,__VA_ARGS__<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>;      \
    asmlinkage <span style="color: #6699cc;">long</span> <span style="color: #f99157;">SyS</span>##<span style="color: #f99157;">name</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span>x,__SC_LONG,__VA_ARGS__<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>       \
    <span style="color: #cccccc;">{</span>                                                               \
        <span style="color: #6699cc;">long</span> <span style="color: #ffcc66;">ret</span> = SYSC##<span style="color: #f99157;">name</span><span style="color: #66cccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #ffcc66;">(</span>x,__SC_CAST,__VA_ARGS__<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>;      \
        <span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span>x,__SC_TEST,__VA_ARGS__<span style="color: #66cccc;">)</span>;                             \
        <span style="color: #f99157;">__PROTECT</span><span style="color: #66cccc;">(</span>x, ret,<span style="color: #f99157;">__MAP</span><span style="color: #ffcc66;">(</span>x,__SC_ARGS,__VA_ARGS__<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>;           \
        <span style="color: #99cc99;">return</span> ret;                                                 \
    <span style="color: #cccccc;">}</span>                                                               \
    <span style="color: #99cc99;">static</span> <span style="color: #99cc99;">inline</span> <span style="color: #6699cc;">long</span> <span style="color: #f99157;">SYSC</span>##<span style="color: #f99157;">name</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span>x,__SC_DECL,__VA_ARGS__<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>
</pre>
</div>

<p>
<code>SYSCALL_DEFINE3(poll, struct pollfd __user *, ufds, unsigned int, nfds, int, timeout_msecs)</code> 通过宏展开后:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#32473;sys_poll&#36215;&#30340;&#21035;&#21517;&#20026;Sys_poll </span><span style="color: #999999; font-style: italic;">*/</span>
asmlinkage <span style="color: #6699cc;">long</span> <span style="color: #f99157;">sys_poll</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">3</span>, __SC_DECL, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>
    <span style="color: #f99157;">__attribute__</span><span style="color: #cccccc;">(</span><span style="color: #66cccc;">(</span><span style="color: #f99157;">alias</span><span style="color: #ffcc66;">(</span><span style="color: #f99157;">__stringify</span><span style="color: #99cc99;">(</span>SyS_poll<span style="color: #99cc99;">)</span><span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>;
<span style="color: #99cc99;">static</span> <span style="color: #99cc99;">inline</span> <span style="color: #6699cc;">long</span> <span style="color: #f99157;">SYSC_poll</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">3</span>, __SC_DECL, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>;

<span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">Sys_poll&#20989;&#25968;&#23558;&#21442;&#25968;&#31867;&#22411;&#24378;&#36716;&#20026;long&#31867;&#22411; </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #6699cc;">asmlinkage</span> <span style="color: #f99157;">SyS_poll</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">3</span>, __SC_LONG, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>;
<span style="color: #6699cc;">asmlinkage</span> <span style="color: #f99157;">SyS_poll</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">3</span>, __SC_LONG, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>

    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#23558;&#21442;&#25968;&#31867;&#22411;&#24378;&#36716;&#20026;&#23545;&#24212;&#30340;&#23454;&#38469;&#31867;&#22411;&#65292;&#24182;&#35843;&#29992;&#19979;&#38754;&#23454;&#29616;&#30340;SYSC_poll&#20989;&#25968; </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #6699cc;">long</span> <span style="color: #ffcc66;">ret</span> = <span style="color: #f99157;">SYSC_poll</span><span style="color: #66cccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #ffcc66;">(</span><span style="color: #6699cc;">3</span>, __SC_CAST, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>;
    <span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">3</span>, __SC_TEST, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #66cccc;">)</span>;
    <span style="color: #f99157;">__PROTECT</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">3</span>, ret, <span style="color: #f99157;">__MAP</span><span style="color: #ffcc66;">(</span><span style="color: #6699cc;">3</span>, __SC_ARGS, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>;
    <span style="color: #99cc99;">return</span> ret;
<span style="color: #cccccc;">}</span>
<span style="color: #99cc99;">static</span> <span style="color: #99cc99;">inline</span> <span style="color: #6699cc;">long</span> <span style="color: #f99157;">SYSC_poll</span><span style="color: #cccccc;">(</span><span style="color: #f99157;">__MAP</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">3</span>, __SC_DECL, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *, ufds, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span>, nfds, <span style="color: #6699cc;">int</span>, timeout_msecs<span style="color: #66cccc;">)</span><span style="color: #cccccc;">)</span>
</pre>
</div>

那么<span id="inline-yellow">__MAP</span>  <span id="inline-purple">__SC_CAST</span>  <span id="inline-blue">__SC_DECL</span> 以及 <span id="inline-green">__SC_LONG</span>
这些宏又是如何实现的：


<div class="org-src-container">
<pre class="src src-C"><span style="color: #cc99cc;">#define</span> <span style="color: #f99157;">__MAP</span><span style="color: #cccccc;">(</span><span style="color: #ffcc66;">n</span>,...<span style="color: #cccccc;">)</span> __MAP##<span style="color: #f99157;">n</span><span style="color: #cccccc;">(</span>__VA_ARGS__<span style="color: #cccccc;">)</span>

<span style="color: #cc99cc;">#define</span> <span style="color: #f99157;">__MAP1</span><span style="color: #cccccc;">(</span><span style="color: #ffcc66;">m</span>,<span style="color: #ffcc66;">t</span>,<span style="color: #ffcc66;">a</span><span style="color: #cccccc;">)</span> <span style="color: #f99157;">m</span><span style="color: #cccccc;">(</span>t,a<span style="color: #cccccc;">)</span>
<span style="color: #cc99cc;">#define</span> <span style="color: #f99157;">__MAP2</span><span style="color: #cccccc;">(</span><span style="color: #ffcc66;">m</span>,<span style="color: #ffcc66;">t</span>,<span style="color: #ffcc66;">a</span>,...<span style="color: #cccccc;">)</span> <span style="color: #f99157;">m</span><span style="color: #cccccc;">(</span>t,a<span style="color: #cccccc;">)</span>, <span style="color: #f99157;">__MAP1</span><span style="color: #cccccc;">(</span>m,__VA_ARGS__<span style="color: #cccccc;">)</span>
<span style="color: #cc99cc;">#define</span> <span style="color: #f99157;">__MAP3</span><span style="color: #cccccc;">(</span><span style="color: #ffcc66;">m</span>,<span style="color: #ffcc66;">t</span>,<span style="color: #ffcc66;">a</span>,...<span style="color: #cccccc;">)</span> <span style="color: #f99157;">m</span><span style="color: #cccccc;">(</span>t,a<span style="color: #cccccc;">)</span>, <span style="color: #f99157;">__MAP2</span><span style="color: #cccccc;">(</span>m,__VA_ARGS__<span style="color: #cccccc;">)</span>

<span style="color: #cc99cc;">#define</span> <span style="color: #f99157;">__SC_DECL</span><span style="color: #cccccc;">(</span><span style="color: #ffcc66;">t</span>, <span style="color: #ffcc66;">a</span><span style="color: #cccccc;">)</span> <span style="color: #6699cc;">t</span> <span style="color: #ffcc66;">a</span>

<span style="color: #999999; font-style: italic;">/********************************************************************************************************************/</span>
<span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#23545;&#20110;__MAP(3, __SC_DECL, struct pollfd __user *, ufds, unsigned int, nfds, int, timeout_msecs)                    </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#23637;&#24320;&#21518;&#21363;&#20026; __SC_DECL(struct pollfd __user *, ufds), __MAP2(__SC_DECL, unsigned int, nfds, int, timeout_msecs)    </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#36827;&#19968;&#27493;&#23637;&#24320; __SC_DECL(struct pollfd __user *, ufds), __SC_DECL(unsigned int, nfds), __SC_DECL(int, timeout_msecs) </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#26368;&#32456;&#21363;&#20026; struct pollfd __user * ufds, unsigned int nfds, int timeout_msecs                                       </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #999999; font-style: italic;">/********************************************************************************************************************/</span>
</pre>
</div>

<p>
可见__MAP和__SC_DECL宏的主要作用是进行参数类型和参数的配对，而当和__SC_LONG配对使用时就是将所有的参数类型强转为long类型进行接受，这样转来转去为了啥？原因就是64位linux系统下有个名为CVE-2009-2009的漏洞，ABI规定在64位平台的在系统调用时，必须确保用户空间将系统调用中32位的参数存放在64位的寄存器中并保证正确的符合扩展，但是用户空间程序并不能保证做到这点，这就有可能向有漏洞的系统调用传送特制参数导致系统崩溃或者权限提升。
</p>

<blockquote>
<p>
ABI: Application Binary Interface, 定义了的内容大概有：
</p>
<ol class="org-ol">
<li>数据类型的大小，布局和对齐方式。</li>
<li>控制函数的参数如何进行传递以及如何接受返回值，例如，通过栈还是部分通过寄存器等。</li>
<li>应用如何使用系统调用。</li>
<li>目标文件的二进制格式，程序库等。</li>
</ol>
</blockquote>
</div>
</div>

<div id="org8c499fc" class="outline-2">
<h2 id="org8c499fc">do_sys_poll</h2>
<div class="outline-text-2" id="text-org8c499fc">
<p>
讲了这么多，才刚分析完sys_poll是如何定义的，sys_poll会调用do_sys_poll，接下来看do_sys_poll函数做了哪些事情:
</p>

<ul class="org-ul">
<li>将用户传入的pollfd数组拷贝到内核空间。</li>
<li>遍历查询传入的pollfd数组中文件描述符对应设备的状态，如果所有设备都没有关心的事件发生，这时则需要挂起当前进程，直到有事件到来或者超时将其唤醒。如果有事件到来，则再次遍历所有设备，定位事件。</li>
<li>将获得的事件返回到用户空间，并释放分配的内存以及移除等待队列。</li>
</ul>


<div class="org-src-container">
<pre class="src src-C"><span style="color: #6699cc;">int</span> <span style="color: #f99157;">do_sys_poll</span><span style="color: #cccccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> <span style="color: #6699cc;">__user</span> *<span style="color: #ffcc66;">ufds</span>, <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">nfds</span>,
                <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">timespec</span> *<span style="color: #ffcc66;">end_time</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">1.&#25191;&#34892;&#25335;&#36125;&#21160;&#20316; </span><span style="color: #999999; font-style: italic;">*/</span>
    ...

    <span style="color: #999999; font-style: italic;">/*</span><span style="color: #999999; font-style: italic;">2. &#36941;&#21382;&#26597;&#35810; </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #f99157;">poll_initwait</span><span style="color: #66cccc;">(</span>&amp;table<span style="color: #66cccc;">)</span>;
    fdcount = <span style="color: #f99157;">do_poll</span><span style="color: #66cccc;">(</span>nfds, head, &amp;table, end_time<span style="color: #66cccc;">)</span>&#65307;

    <span style="color: #999999; font-style: italic;">/*</span><span style="color: #999999; font-style: italic;">3. &#31227;&#38500;&#31561;&#24453;&#38431;&#21015;&#65292;&#37322;&#25918;&#20869;&#23384;&#65292;&#23558;&#20107;&#20214;&#25335;&#36125;&#22238;&#29992;&#25143;&#31354;&#38388; </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #f99157;">poll_freewait</span><span style="color: #66cccc;">(</span>&amp;table<span style="color: #66cccc;">)</span>;
    ...
<span style="color: #cccccc;">}</span>
</pre>
</div>
</div>



<div id="orgad94933" class="outline-3">
<h3 id="orgad94933">拷贝</h3>
<div class="outline-text-3" id="text-orgad94933">
<p>
在进行拷贝时，先申请一段栈空间，转换为poll_list类型，剩余的空间则被用来存放pollfd数组，在查询的文件描述符较少时，由于变量是存放在栈空间，这样速度可以更快，而且可以节省memory。在文件描述符超过所申请的栈空间时，再额外的分配所需空间，完成剩下的拷贝工作。
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #6699cc;">long</span> <span style="color: #ffcc66;">stack_pps</span><span style="color: #cccccc;">[</span>POLL_STACK_ALLOC/<span style="color: #f99157;">sizeof</span><span style="color: #66cccc;">(</span><span style="color: #6699cc;">long</span><span style="color: #66cccc;">)</span><span style="color: #cccccc;">]</span>;
<span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_list</span> *<span style="color: #99cc99;">const</span> <span style="color: #ffcc66;">head</span> = <span style="color: #cccccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_list</span> *<span style="color: #cccccc;">)</span>stack_pps;
<span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_list</span> *<span style="color: #ffcc66;">walk</span> = head;
<span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">long</span> <span style="color: #ffcc66;">todo</span> = nfds;

<span style="color: #99cc99;">for</span> <span style="color: #cccccc;">(</span>;;<span style="color: #cccccc;">)</span> <span style="color: #cccccc;">{</span>
    walk-&gt;next = <span style="color: #6699cc;">NULL</span>;
    walk-&gt;len = len;
    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span><span style="color: #6699cc;">!</span>len<span style="color: #66cccc;">)</span>
        <span style="color: #99cc99;">break</span>;

    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#25335;&#36125;pollfd&#25968;&#32452;&#21040;poll_list&#20013;&#30340;entries&#25104;&#21592;&#20013; </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span><span style="color: #f99157;">copy_from_user</span><span style="color: #ffcc66;">(</span>walk-&gt;entries, ufds + nfds-todo,
                        <span style="color: #f99157;">sizeof</span><span style="color: #99cc99;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span><span style="color: #99cc99;">)</span> * walk-&gt;len<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>
        <span style="color: #99cc99;">goto</span> <span style="color: #6699cc;">out_fds</span>;

    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">todo&#21021;&#22987;&#20540;&#20026;&#35201;&#25335;&#36125;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#20010;&#25968; </span><span style="color: #999999; font-style: italic;">*/</span>
    todo -= walk-&gt;len;
    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span><span style="color: #6699cc;">!</span>todo<span style="color: #66cccc;">)</span>
        <span style="color: #99cc99;">break</span>;

    len = <span style="color: #f99157;">min</span><span style="color: #66cccc;">(</span>todo, POLLFD_PER_PAGE<span style="color: #66cccc;">)</span>;
    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#24403;&#35201;&#26597;&#35810;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#22823;&#20110;&#39044;&#20808;&#22312;&#26632;&#20013;&#30003;&#35831;&#30340;&#31354;&#38388;&#26102;&#65292;&#30003;&#35831;&#20998;&#37197;&#20869;&#23384; </span><span style="color: #999999; font-style: italic;">*/</span>
    size = <span style="color: #f99157;">sizeof</span><span style="color: #66cccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_list</span><span style="color: #66cccc;">)</span> + <span style="color: #f99157;">sizeof</span><span style="color: #66cccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span><span style="color: #66cccc;">)</span> * len;
    walk = walk-&gt;next = <span style="color: #f99157;">kmalloc</span><span style="color: #66cccc;">(</span>size, GFP_KERNEL<span style="color: #66cccc;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span><span style="color: #6699cc;">!</span>walk<span style="color: #66cccc;">)</span> <span style="color: #66cccc;">{</span>
        err = -ENOMEM;
        <span style="color: #99cc99;">goto</span> <span style="color: #6699cc;">out_fds</span>;
    <span style="color: #66cccc;">}</span>
<span style="color: #cccccc;">}</span>
</pre>
</div>
</div>
</div>


<div id="orgf11d2a0" class="outline-3">
<h3 id="orgf11d2a0">查询事件</h3>
<div class="outline-text-3" id="text-orgf11d2a0">
</div><div id="orgf73b4a8" class="outline-4">
<h4 id="orgf73b4a8">poll_initwait</h4>
<div class="outline-text-4" id="text-orgf73b4a8">
<p>
初始化poll_wqueues变量table。
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #f99157;">poll_initwait</span><span style="color: #cccccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_wqueues</span> *<span style="color: #ffcc66;">pwq</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#23558;poll_table&#20013;&#30340;_qproc&#20989;&#25968;&#21464;&#37327;&#21021;&#22987;&#21270;&#20026;__pollwait&#65292;_key&#35774;&#32622;&#20026;(~0UL) </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #f99157;">init_poll_funcptr</span><span style="color: #66cccc;">(</span>&amp;pwq-&gt;pt, __pollwait<span style="color: #66cccc;">)</span>;
    pwq-&gt;polling_task = current;
    pwq-&gt;triggered = <span style="color: #6699cc;">0</span>;
    pwq-&gt;error = <span style="color: #6699cc;">0</span>;
    pwq-&gt;table = <span style="color: #6699cc;">NULL</span>;
    pwq-&gt;inline_index = <span style="color: #6699cc;">0</span>;
<span style="color: #cccccc;">}</span>
</pre>
</div>

<p>
__pollwait函数在驱动中的poll实现中通过poll_wait函数调用，这里先看下它的实现：
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">Add a new entry </span><span style="color: #999999; font-style: italic;">*/</span>
<span style="color: #99cc99;">static</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">__pollwait</span><span style="color: #cccccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">file</span> *<span style="color: #ffcc66;">filp</span>, <span style="color: #6699cc;">wait_queue_head_t</span> *<span style="color: #ffcc66;">wait_address</span>,
                       <span style="color: #6699cc;">poll_table</span> *<span style="color: #ffcc66;">p</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_wqueues</span> *<span style="color: #ffcc66;">pwq</span> = <span style="color: #f99157;">container_of</span><span style="color: #66cccc;">(</span>p, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_wqueues</span>, pt<span style="color: #66cccc;">)</span>;
    <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_table_entry</span> *<span style="color: #ffcc66;">entry</span> = <span style="color: #f99157;">poll_get_entry</span><span style="color: #66cccc;">(</span>pwq<span style="color: #66cccc;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span><span style="color: #6699cc;">!</span>entry<span style="color: #66cccc;">)</span>
        <span style="color: #99cc99;">return</span>;
    entry-&gt;filp = <span style="color: #f99157;">get_file</span><span style="color: #66cccc;">(</span>filp<span style="color: #66cccc;">)</span>; <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">&#20445;&#23384;&#35774;&#22791;&#25991;&#20214;</span>
    entry-&gt;wait_address = wait_address; <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">&#20445;&#23384;&#26469;&#33258;&#35774;&#22791;&#39537;&#21160;&#30340;&#31561;&#24453;&#38431;&#21015;&#22836;</span>
    entry-&gt;key = p-&gt;_key; <span style="color: #999999; font-style: italic;">//</span><span style="color: #999999; font-style: italic;">&#20445;&#23384;&#35774;&#22791;&#25152;&#20851;&#24515;&#30340;events</span>
    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#21021;&#22987;&#21270;&#31561;&#24453;&#38431;&#21015;&#39033;&#65292;&#24182;&#23558;&#21796;&#37266;&#35813;&#31561;&#24453;&#38431;&#21015;&#39033;&#30340;&#20989;&#25968;&#27880;&#20876;&#20026;pollwake </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #f99157;">init_waitqueue_func_entry</span><span style="color: #66cccc;">(</span>&amp;entry-&gt;wait, pollwake<span style="color: #66cccc;">)</span>;
    entry-&gt;wait.private = pwq;
    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#28155;&#21152;&#31561;&#24453;&#38431;&#21015;&#39033;&#21040;&#31561;&#24453;&#38431;&#21015;&#22836; </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #f99157;">add_wait_queue</span><span style="color: #66cccc;">(</span>wait_address, &amp;entry-&gt;wait<span style="color: #66cccc;">)</span>;
<span style="color: #cccccc;">}</span>
</pre>
</div>
</div>
</div>

<div id="orgd57ceb1" class="outline-4">
<h4 id="orgd57ceb1">do_poll</h4>
<div class="outline-text-4" id="text-orgd57ceb1">
<p>
先上源码：
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #99cc99;">static</span> <span style="color: #6699cc;">int</span> <span style="color: #f99157;">do_poll</span><span style="color: #cccccc;">(</span><span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">nfds</span>,  <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_list</span> *<span style="color: #ffcc66;">list</span>,
           <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_wqueues</span> *<span style="color: #ffcc66;">wait</span>, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">timespec</span> *<span style="color: #ffcc66;">end_time</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    <span style="color: #99cc99;">for</span> <span style="color: #66cccc;">(</span>;;<span style="color: #66cccc;">)</span> <span style="color: #66cccc;">{</span>
        <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_list</span> *<span style="color: #ffcc66;">walk</span>;
        <span style="color: #6699cc;">bool</span> <span style="color: #ffcc66;">can_busy_loop</span> = <span style="color: #6699cc;">false</span>;

        <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#36941;&#21382;&#25152;&#26377;&#30340;pollfd </span><span style="color: #999999; font-style: italic;">*/</span>
        <span style="color: #99cc99;">for</span> <span style="color: #ffcc66;">(</span>walk = list; walk != <span style="color: #6699cc;">NULL</span>; walk = walk-&gt;next<span style="color: #ffcc66;">)</span> <span style="color: #ffcc66;">{</span>
            <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> * <span style="color: #ffcc66;">pfd</span>, * <span style="color: #ffcc66;">pfd_end</span>;

            pfd = walk-&gt;entries;
            pfd_end = pfd + walk-&gt;len;
            <span style="color: #99cc99;">for</span> <span style="color: #99cc99;">(</span>; pfd != pfd_end; pfd++<span style="color: #99cc99;">)</span> <span style="color: #99cc99;">{</span>
                <span style="color: #99cc99;">if</span> <span style="color: #6699cc;">(</span><span style="color: #f99157;">do_pollfd</span><span style="color: #cccccc;">(</span>pfd, pt, &amp;can_busy_loop,
                          busy_flag<span style="color: #cccccc;">)</span><span style="color: #6699cc;">)</span> <span style="color: #6699cc;">{</span>
                    count++;
                    pt-&gt;_qproc = <span style="color: #6699cc;">NULL</span>;
                    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">found something, stop busy polling </span><span style="color: #999999; font-style: italic;">*/</span>
                    busy_flag = <span style="color: #6699cc;">0</span>;
                    can_busy_loop = <span style="color: #6699cc;">false</span>;
                <span style="color: #6699cc;">}</span>
            <span style="color: #99cc99;">}</span>
        <span style="color: #ffcc66;">}</span>

        pt-&gt;_qproc = <span style="color: #6699cc;">NULL</span>;
        ...

        <span style="color: #99cc99;">if</span> <span style="color: #ffcc66;">(</span><span style="color: #6699cc;">!</span><span style="color: #f99157;">poll_schedule_timeout</span><span style="color: #99cc99;">(</span>wait, TASK_INTERRUPTIBLE, to, slack<span style="color: #99cc99;">)</span><span style="color: #ffcc66;">)</span>
            timed_out = <span style="color: #6699cc;">1</span>;
    <span style="color: #66cccc;">}</span>
<span style="color: #cccccc;">}</span>
</pre>
</div>

<p>
do_pollfd会调用到文件描述符所对应设备驱动程序中的poll函数指针，该函数相信很多人都知道怎么去写，但是为什么这样写，而且它具体做了哪些事情，这里在内核目录下找了ucma的poll实现：
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #99cc99;">static</span> <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span> <span style="color: #f99157;">ucma_poll</span><span style="color: #cccccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">file</span> *<span style="color: #ffcc66;">filp</span>, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_table_struct</span> *<span style="color: #ffcc66;">wait</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">ucma_file</span> *<span style="color: #ffcc66;">file</span> = filp-&gt;private_data;
    <span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">mask</span> = <span style="color: #6699cc;">0</span>;

    <span style="color: #f99157;">poll_wait</span><span style="color: #66cccc;">(</span>filp, &amp;file-&gt;poll_wait, wait<span style="color: #66cccc;">)</span>;

    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span><span style="color: #6699cc;">!</span><span style="color: #f99157;">list_empty</span><span style="color: #ffcc66;">(</span>&amp;file-&gt;event_list<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>
        mask = POLLIN | POLLRDNORM;

    <span style="color: #99cc99;">return</span> mask;
<span style="color: #cccccc;">}</span>
</pre>
</div>

<p>
poll_wait()虽然具有wait字样，但是并不会阻塞在这里，不然如果应用程序同时监控多个设备文件，每个poll函数都阻塞的话，也不会称为IO复用了。所以do_pollfd的真正作用有两个：
</p>
<ol class="org-ol">
<li>利用poll_wait()将后续等待设备就绪的进程对应的等待队列项添加到驱动程序提供的等待队列头中。（仅在第一次轮循中使用，第一次轮循环结束后poll_table的_qproc被置为NULL）</li>
<li>查询当前是否有关心的事件到来。</li>
</ol>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #99cc99;">static</span> <span style="color: #99cc99;">inline</span> <span style="color: #6699cc;">void</span> <span style="color: #f99157;">poll_wait</span><span style="color: #cccccc;">(</span><span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">file</span> * <span style="color: #ffcc66;">filp</span>, <span style="color: #6699cc;">wait_queue_head_t</span> * <span style="color: #ffcc66;">wait_address</span>, <span style="color: #6699cc;">poll_table</span> *<span style="color: #ffcc66;">p</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#22312;poll_initwait&#20013;_qproc&#25351;&#21521;__pollwait()&#20989;&#25968; </span><span style="color: #999999; font-style: italic;">*/</span>
    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span>p &amp;&amp; p-&gt;_qproc &amp;&amp; wait_address<span style="color: #66cccc;">)</span>
        p-&gt;<span style="color: #f99157;">_qproc</span><span style="color: #66cccc;">(</span>filp, wait_address, p<span style="color: #66cccc;">)</span>;
<span style="color: #cccccc;">}</span>
</pre>
</div>

<p>
__pollwait()的实现详见上一小节，对于不同的进程当调用poll监测同一个设备文件描述符时都会有分配一个poll_table_entry项,并将等待队列项加入到相同的等待队列头中，都为驱动程序中所初始化的等待队列头。因此当设备就绪时，就会唤醒所有在该等待队列头中的所有等待队列项。
</p>


<p>
若无事件发生，do_poll中的poll_schedule_timeout()会挂起当前进程，直到有事件（比如说POLLIN）到来时，可以通过wake_up_interruptible()"唤醒"处于设备驱动程序等待队列头的等待队列项，这时会调用之前__pollwait注册的回调函数pollwake函数，它通过container_of找到等待队列项对应的poll_table_entry项，最后调用__pollwake真正唤醒当前挂起的进程。
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #99cc99;">static</span> <span style="color: #6699cc;">int</span> <span style="color: #f99157;">pollwake</span><span style="color: #cccccc;">(</span><span style="color: #6699cc;">wait_queue_t</span> *<span style="color: #ffcc66;">wait</span>, <span style="color: #6699cc;">unsigned</span> <span style="color: #ffcc66;">mode</span>, <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">sync</span>, <span style="color: #6699cc;">void</span> *<span style="color: #ffcc66;">key</span><span style="color: #cccccc;">)</span>
<span style="color: #cccccc;">{</span>
    <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_table_entry</span> *<span style="color: #ffcc66;">entry</span>;

    entry = <span style="color: #f99157;">container_of</span><span style="color: #66cccc;">(</span>wait, <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_table_entry</span>, wait<span style="color: #66cccc;">)</span>;
    <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span>key &amp;&amp; <span style="color: #6699cc;">!</span><span style="color: #ffcc66;">(</span><span style="color: #99cc99;">(</span><span style="color: #6699cc;">unsigned</span> <span style="color: #6699cc;">long</span><span style="color: #99cc99;">)</span>key &amp; entry-&gt;key<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>
        <span style="color: #99cc99;">return</span> <span style="color: #6699cc;">0</span>;
    <span style="color: #99cc99;">return</span> <span style="color: #f99157;">__pollwake</span><span style="color: #66cccc;">(</span>wait, mode, sync, key<span style="color: #66cccc;">)</span>;
<span style="color: #cccccc;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="org2a1e886" class="outline-3">
<h3 id="org2a1e886">清理并返回用户空间</h3>
<div class="outline-text-3" id="text-org2a1e886">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #f99157;">poll_freewait</span><span style="color: #cccccc;">(</span>&amp;table<span style="color: #cccccc;">)</span>;

<span style="color: #99cc99;">for</span> <span style="color: #cccccc;">(</span>walk = head; walk; walk = walk-&gt;next<span style="color: #cccccc;">)</span> <span style="color: #cccccc;">{</span>
    <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">pollfd</span> *<span style="color: #ffcc66;">fds</span> = walk-&gt;entries;
    <span style="color: #6699cc;">int</span> <span style="color: #ffcc66;">j</span>;

    <span style="color: #99cc99;">for</span> <span style="color: #66cccc;">(</span>j = <span style="color: #6699cc;">0</span>; j &lt; walk-&gt;len; j++, ufds++<span style="color: #66cccc;">)</span>
        <span style="color: #999999; font-style: italic;">/* </span><span style="color: #999999; font-style: italic;">&#25335;&#36125;&#22238;&#29992;&#25143;&#31354;&#38388; </span><span style="color: #999999; font-style: italic;">*/</span>
        <span style="color: #99cc99;">if</span> <span style="color: #66cccc;">(</span><span style="color: #f99157;">__put_user</span><span style="color: #ffcc66;">(</span>fds<span style="color: #99cc99;">[</span>j<span style="color: #99cc99;">]</span>.revents, &amp;ufds-&gt;revents<span style="color: #ffcc66;">)</span><span style="color: #66cccc;">)</span>
            <span style="color: #99cc99;">goto</span> <span style="color: #6699cc;">out_fds</span>;
<span style="color: #cccccc;">}</span>

err = fdcount;
<span style="color: #6699cc;">out_fds</span>:
walk = head-&gt;next;
<span style="color: #99cc99;">while</span> <span style="color: #cccccc;">(</span>walk<span style="color: #cccccc;">)</span> <span style="color: #cccccc;">{</span>
    <span style="color: #99cc99;">struct</span> <span style="color: #6699cc;">poll_list</span> *<span style="color: #ffcc66;">pos</span> = walk;
    walk = walk-&gt;next;
    <span style="color: #f99157;">kfree</span><span style="color: #66cccc;">(</span>pos<span style="color: #66cccc;">)</span>;
<span style="color: #cccccc;">}</span>
</pre>
</div>
</div>
</div>
</div>
